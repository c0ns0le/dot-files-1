#!/bin/bash

function is_attached() {
  tmux ls | grep attached &>/dev/null
  return $?
}

function pomo_runner() {
  is_attached && return 1
  echo "$@" >~/.pomos/pomo_runner
}

function pomo_listener() {
  echo "$@" >~/.pomos/pomo_commands
}

function attach_runner() {
  echo tmux a >~/.pomos/pomo_runner
}

function clear_fifo() {
  [ -p $1 ] && echo "removing $1" && rm -v "$1"
  if [ ! -p $1 ]; then
    mkdir -pv "$(dirname "$1")"
    mkfifo "$1"
  fi
}

pomodoro () {
  for min in $(seq ${1:-25} 1)
  do

    [[ $(( $min % 5 )) -eq 0 ]] && say "$min minutes left" &
    [[ $min -lt 4 && $min -ne 1 ]] && say "$min minutes left" &
    [[ $min -eq 1 ]] && say "$min minute left" &

    pomo_runner echo "$min minutes left"

    echo -n "$(printf "%02d" $min) => "

    for b in $(seq 1 20)
    do
      sleep 3
      echo -n '.'
    done

    echo
  done
}

case $1 in
  (''|start)
    pomodoro 25
  ;;

  (clear)
    clear_fifo ~/.pomos/pomo_commands
    clear_fifo ~/.pomos/pomo_runner
    ;;

  (run)
    total=0
    while true
    do
      for session in $(seq 1 4)
      do
        total=$(( $total + 1 ))
        echo
        echo "Session #$total"

        pomo 25
        pomo d

        echo
        [[ $session -lt 4 ]] && pomo sb || pomo lb
        pomo a
        say "break is over" &
      done
    done
  ;;

  (a|attach)
    attach_runner
    ;;

  (d|detach)
    pomo_listener tmux detach
    ;;

  (sb|short-break|short|break)
    pomodoro 5
  ;;

  (lb|long-break|long)
    pomodoro 15
  ;;

  ([0-9]*)
    pomodoro $1
  ;;

  (*)
    cat <<OPTIONS
  USAGE:

    pomo                # => 25m timer

    pomo [0-9]+         # => timer for specified minutes

    pomo sb             # => 5m timer
    pomo short          # => 5m timer
    pomo short-break    # => 5m timer
    pomo break          # => 5m timer

    pomo lb             # => 15m timer
    pomo long           # => 15m timer
    pomo long-break     # => 15m timer

    pomo help           # => This help message

OPTIONS
  ;;

esac
