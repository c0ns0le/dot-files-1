#!/bin/bash

function start_listener() {
  if [ ! -p ~/.pomos/pomo_commands ]; then
    mkdir -pv ~/.pomos
    mkfifo ~/.pomos/pomo_commands
  fi

  dir="${1:-beautified}"

  echo
  echo "Pomodoro Listener Started..."
  echo

  tmux ls
  if [[ $? -eq 0 ]]; then
    echo "$? == 0"
    echo 'echo tmux a >~/.pomos/pomo_runner' >~/.pomos/pomo_commands &
  else
    echo "$? > 0"
    echo "echo tmux >~/.pomos/pomo_runner; sleep 2; tmux send-keys 'cd;cd $dir;clear' \; split-window \; send-keys 'cd;cd $dir;clear;test_listener' \; split-window \; send-keys 'cd;cd $dir;clear' \; split-window \; send-keys 'pomo run' \; select-layout '9d01,204x44,0,0[204x32,0,0,0,204x11,0,33{88x11,0,33,1,87x11,89,33,2,27x11,177,33,3}]' " >~/.pomos/pomo_commands &
  fi

  while true
  do
    cmd="$(cat ~/.pomos/pomo_commands)"
    echo "$cmd"
    bash -c "$cmd"
  done
}

case $1 in
  (-e|--edit|-edit)
    vim "$0"
    ;;
  (*)
    start_listener "$@"
    ;;
esac

